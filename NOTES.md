# greengrocer
Sales tracker application written in Django

# 全般の工夫点

## 環境設定
- `settings.py` → 本来であればDevelopment、Productionなどに分けるが、ローカルで動かすことがメインとなるためほとんど変更していません。
- SECRET_KEYはそのままになっているが、本来であれば環境もしくは別ファイルに保存し、os.environで読み込む。
- STATIC_FILESについては、ローカルだけで動かしているので、`DEBUG = False`の場合は`python manage.py runserver --insecure`で起動しないとと読み込まれない。

## フロントエンド
- Bootstrap 3を使用しているため、モバイルデバイスでの表示にも対応している。
- Djangoフォームの標準設定ではBootstrapが組み込みづらいため、`django-widget-tweaks`パッケージを使用し、ラベル・フィールドのカスタムデザインを加えた。


# Views

## ログイン画面
- Django標準の認証システムを運用している。ユーザ登録機能は実装していないため、`python manage.py createsuperuser`でSuperuserを登録し、他のユーザアカウントが必要な場合はDjango Adminから登録する。
- ログインエラー（ユーザ名、パスワードなど）はログインフォームに表示される。
- ログインしていない場合、強制的にこのページにリダイレクトされる。
- 存在していないページからリダイレクトされた場合も、ログイン画面の下にエラーメッセージが表示される。(`django.contrib.messages`を利用している)

## Top画面
 - おおむね仕様説明に基づいて作成したが、右上にログアウトボタンを追加した。
 - ログイン済みのユーザは、404/500エラーが生じた場合このページにリダイレクトされる。その際、ページの下にエラーメッセージが表示される。
 - リンクは原則、`urls.py`で指定し、`{% url 'hoge' %}`としてテンプレートに埋め込んだ。

## 商品マスタ管理
  - 操作等は仕様説明の通りに動く。
  - 一覧は`django.views.generic.ListView`、登録／編集画面は`CreateView`, `EditView`を使用した。Mixinを使用することによって、重複なく構築している。
  - 単純なページネーションはページ下部分につけてある（レコードが20件を超えた場合表示される）
  - ログイン条件はそれぞれ`@login_required`, `LoginRequiredMixin`でチェックしている。

## 販売情報管理
  - 操作等は仕様説明の通りに動く。
  - 基本的な表示科目は商品マスタ管理と同様に実装している。
  - CSV一括アップロードは、フロントエンドの方でファイル名末尾が`.csv`であればアップロードボタンが有効になる（jQuery）。
  - Viewのコードで、同様にファイル名末尾のチェック、ファイルサイズが大きすぎないかをチェックし、一行ごとに販売情報をレコードに登録する。
  - 正常に登録できなかったレコード以外は`pass`していく。（`except Exception as e:`としているが、本当はアンチパターンを避けてもう少し丁寧に処理した方が良いかもしれない。）

## 商品＆販売情報登録／編集フォーム
  - 操作等は仕様説明の通りに動く。
  - 各項目の必須形式チェック、モデルで指定されているため無効な値は登録できないようになっている。
  - 他に問題になりそうな記入値（例えば商品名が短すぎる、長すぎる、個数が多すぎる、価格が高すぎる）については`forms.py`でチェックしている。
  - 販売情報登録フォームの仕様説明では「売り上げ」を指定しないことになっているため、フォーム送信時モデルのメソッドで計算し登録する仕組みを実装した。編集画面については、全項目が編集できるようになっている。
  
## 商品販売管理
  - 仕様説明の通り、Django ORMを利用せず実装した。
  - 詳細は次の通り。
  - *累計*はDBより販売情報を全レコード取得し、`amount`を集計する。(累計だけ必要であれば、`Transaction.objects.all()`ではなくて、`Transactions.objects.value('amount')`を使うが、月別・日別の時にもレコードが必要なため`all`のまま)
  - *月別・日別*のロジックは似ている。それぞれ現時点の年月日を取得し、`timedelta`を使用し、過去3ヶ月（3日間）の年月日をリストに加えていく。リストに加えて日付に沿って、該当する販売登録を別のリストにまず保存していく。`Transaction`レコードでは基本的に商品一つしか登録できないため、別に`Ledger`クラスを作成した。`Ledger`は`datetime`と`dict`を所有し、指定された日付に合う販売情報をインスタンスの辞書に集約することができる。（Viewでしか必要ないため、モデルではなくクラスとして実装した）。
  - 過去3日間の機能は問題なく動いているが、過去3ヶ月の実装には致命的欠点がある。`timedelta`は◯ヶ月単位のdeltaを指定できないが、年始→年末を指定するのに便利（ex. 2017-01-01 - timedelta(days=1）=> 2016-12-31）なので、月単位にも使用したかった。3ヶ月という期間では実際問題ないが、長期間のデータ表示が必要な場合は使えなくなってしまうため、その際は`dateutil`パッケージを使っているか、より丁寧に月の日数を示すロジックを書く必要がある。

## 単体テスト
  - 一通り、基本的なテストを実装し、それぞれ仕様説明にある条件を満たしていることが確認できている。
  
